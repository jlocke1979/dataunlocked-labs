<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Club Dispersion</title>
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

<style>
  body { font-family: system-ui; padding: 30px; }
  svg { border: 1px solid #ddd; }
</style>
</head>

<body>
  
  <div id="tooltip"
       style="
         position:absolute;
         background:black;
         color:white;
         padding:6px 10px;
         border-radius:6px;
         font-size:12px;
         pointer-events:none;
         opacity:0;">
  </div>

<h2>Club Fitting Dispersion</h2>
<div id="chart"></div>

<script>

function drawChart(data){

  const width = 900;
  const height = 500;

  d3.select("#chart").selectAll("*").remove();

  const svg = d3.select("#chart")
    .append("svg")
    .attr("width", width)
    .attr("height", height);

  const tooltip = d3.select("#tooltip");

  // =====================
  // COLOR SCALE
  // =====================
  const clubs = [...new Set(data.map(d => d.club))];
  const visibleClubs = new Set(clubs);

  const color = d3.scaleOrdinal()
    .domain(clubs)
    .range(d3.schemeTableau10);

  // =====================
  // SCALES
  // =====================
  const x = d3.scaleLinear()
    .domain(d3.extent(data,d=>d.sidespin))
    .range([60,width-40]);

  const y = d3.scaleLinear()
    .domain(d3.extent(data,d=>d.carry))
    .range([height-40,40]);

  // =====================
  // AXES
  // =====================
  svg.append("g")
    .attr("transform",`translate(0,${height-40})`)
    .call(d3.axisBottom(x));

  svg.append("g")
    .attr("transform","translate(60,0)")
    .call(d3.axisLeft(y));

  // =====================
  // MEAN LINE PER CLUB
  // =====================
  const grouped = d3.group(data, d=>d.club);

  grouped.forEach((shots,club)=>{

    const meanCarry = d3.mean(shots,d=>d.carry);

    svg.append("line")
      .attr("x1",60)
      .attr("x2",width-40)
      .attr("y1",y(meanCarry))
      .attr("y2",y(meanCarry))
      .attr("stroke",color(club))
      .attr("stroke-dasharray","4 4")
      .attr("opacity",0.6);
  });

  // =====================
  // DOTS
  // =====================
  function updateDots(){

  const filtered = data.filter(d =>
    visibleClubs.has(d.club)
  );

  const dots = svg.selectAll("circle")
    .data(filtered, d => d);

  dots.join(
    enter => enter.append("circle")
      .attr("cx",d=>x(d.sidespin))
      .attr("cy",d=>y(d.carry))
      .attr("r",4)
      .attr("fill",d=>color(d.club))
      .attr("opacity",0.8),

    update => update,

    exit => exit.remove()
  );
}

updateDots();
  // =====================
  // LEGEND
  // =====================
  const legend = svg.append("g")
  .attr("transform","translate(700,40)");

clubs.forEach((club,i)=>{

  const row = legend.append("g")
    .attr("transform",`translate(0,${i*20})`)
    .style("cursor","pointer");

  row.append("rect")
    .attr("width",12)
    .attr("height",12)
    .attr("fill",color(club));

  row.append("text")
    .attr("x",18)
    .attr("y",10)
    .style("font-size","12px")
    .text(club);

  row.on("click",()=>{

    if(visibleClubs.has(club)){
      visibleClubs.delete(club);
      row.attr("opacity",0.3);
    } else {
      visibleClubs.add(club);
      row.attr("opacity",1);
    }

    updateDots();
  });

});

}
  
d3.csv("fitting.csv").then(raw => {

  const normalize = s =>
    String(s)
      .replace(/\uFEFF/g, "")  // remove BOM if present
      .trim()
      .toLowerCase();

  const data = raw.map(row => {
    const clean = {};
    Object.keys(row).forEach(k => {
      clean[normalize(k)] = row[k];
    });
      return {
        club: String(clean["club"] ?? "")
            .replace(/\s+/g," ")
            .trim()
            .toLowerCase(),

        carry: +clean["carry (yds)"],
    sidespin: +clean["sidespin (rpm)"]
    };
  })
  .filter(d =>
    d.club &&
    Number.isFinite(d.carry) &&
    Number.isFinite(d.sidespin)
  );

  console.log("Loaded rows:", data.length);
  if (data.length === 0) {
    console.log("Detected headers:", Object.keys(raw[0] || {}));
  }

  drawChart(data);

}).catch(err => console.error("CSV LOAD ERROR:", err));
</script>

</body>
</html>
